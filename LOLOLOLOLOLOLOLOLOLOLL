-- Set up your settings using getgenv()
getgenv().HitboxSize = Vector3.new(10, 10, 10)  -- Custom hitbox size
getgenv().Smoothness = 0.3 -- Smoothness factor for camlock
getgenv().AimlockKey = Enum.KeyCode.V -- Default camlock toggle key (can be customized)
getgenv().SmoothnessAmount = 0.2 -- Amount of smoothness for camlock movement

-- External Script (e.g., vortex.lua)
local players = game:GetService("Players")
local runService = game:GetService("RunService")
local tweenService = game:GetService("TweenService")
local userInputService = game:GetService("UserInputService")
local camera = workspace.CurrentCamera

local lastUpdated = tick() -- Store the time of the last update
local updateInterval = 0.1 -- Update every 0.1 seconds to reduce unnecessary processing

local cameraLockEnabled = false -- Boolean to track if camera lock is active
local targetPlayer = nil -- Currently targeted player

-- Whitelist of Roblox IDs (optional, you can skip this if not needed)
local whitelist = {
    7278444088, -- Replace with actual Roblox user IDs
    9876543210, -- Replace with actual Roblox user IDs
    -- Add more user IDs as needed
}

-- Function to check if the player's Roblox ID is in the whitelist
local function isWhitelisted(player)
    for _, id in ipairs(whitelist) do
        if player.UserId == id then
            return true
        end
    end
    return false
end

-- Function to update hitbox and collisions
local function updatePlayerHitbox(player)
    if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
        local hrp = player.Character.HumanoidRootPart
        -- Only update if the size or collision status has changed
        if hrp.Size ~= getgenv().HitboxSize then
            hrp.Size = getgenv().HitboxSize
        end
        if hrp.CanCollide then
            hrp.CanCollide = false
        end
    end
end

-- Find the closest player to the mouse position
local function getClosestPlayerToMouse()
    local mousePos = userInputService:GetMouseLocation()
    local closestPlayer = nil
    local shortestDistance = math.huge

    for _, player in ipairs(players:GetPlayers()) do
        if player ~= players.LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local playerPosition = player.Character.HumanoidRootPart.Position
            local screenPos, onScreen = camera:WorldToScreenPoint(playerPosition)
            if onScreen then
                local distance = (Vector2.new(mousePos.X, mousePos.Y) - Vector2.new(screenPos.X, screenPos.Y)).magnitude
                if distance < shortestDistance then
                    shortestDistance = distance
                    closestPlayer = player
                end
            end
        end
    end

    return closestPlayer
end

-- Smoothly lock the camera onto a target (without teleporting)
local function lockCamera(targetPlayer)
    local targetPosition = targetPlayer.Character and targetPlayer.Character:FindFirstChild("HumanoidRootPart")
    if targetPosition then
        local targetCFrame = targetPosition.CFrame
        -- Create a Tween to smoothly transition the camera
        local tweenInfo = TweenInfo.new(getgenv().Smoothness, Enum.EasingStyle.Linear, Enum.EasingDirection.InOut)
        local goal = {CFrame = camera.CFrame:Lerp(targetCFrame, getgenv().SmoothnessAmount)} -- Smoothly interpolate between current CFrame and target CFrame
        local tween = tweenService:Create(camera, tweenInfo, goal)
        tween:Play()
    end
end

-- Handle camera lock toggle with custom key press (e.g., "V" by default)
userInputService.InputBegan:Connect(function(input)
    if input.KeyCode == getgenv().AimlockKey then
        if not cameraLockEnabled then
            -- Turn on the camera lock
            cameraLockEnabled = true
            targetPlayer = getClosestPlayerToMouse()
            if targetPlayer then
                lockCamera(targetPlayer)
            end
        else
            -- Turn off the camera lock
            cameraLockEnabled = false
            targetPlayer = nil
        end
    end
end)

-- Now that the player is whitelisted, proceed with hitbox expansion
runService.Heartbeat:Connect(function()
    -- Only run the hitbox expander if the player is whitelisted
    if isWhitelisted(players.LocalPlayer) then
        local currentTime = tick()
        if currentTime - lastUpdated >= updateInterval then
            -- Update hitboxes for all players, except the local player
            for _, v in next, players:GetPlayers() do
                if v ~= players.LocalPlayer then
                    updatePlayerHitbox(v)
                end
            end
            lastUpdated = currentTime -- Update the last update time
        end
    end

    -- Camera Lock (Aimlock) processing
    if cameraLockEnabled and targetPlayer then
        if targetPlayer.Character and targetPlayer.Character:FindFirstChild("HumanoidRootPart") then
            lockCamera(targetPlayer)
        end
    end
end)

-- Show Loading Notification once the player is whitelisted
game:GetService("StarterGui"):SetCore("SendNotification", {
    Title = "Whitelisted", 
    Text = "Ready!",
    Icon = "rbxassetid://1234567890", -- Optional icon
    Duration = 3 -- Duration for the "Ready!" message
})
