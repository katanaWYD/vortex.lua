-- External Script (vortex.lua)

-- Ensure proper settings are initialized
local macroToggleKey = getgenv().MacroToggleKey or "x"  -- Default key for macro toggle
local triggerbotToggleKey = getgenv().TriggerbotToggleKey or "z"  -- Default key for triggerbot toggle
local players = game:GetService("Players")
local runService = game:GetService("RunService")
local mouse = game:GetService("Players").LocalPlayer:GetMouse()

local triggerbotEnabled = getgenv().triggerbotEnabled or false  -- Initialize triggerbot state

-- Function to check if the current tool is a knife
local function isKnifeEquipped()
    local tool = game.Players.LocalPlayer.Character:FindFirstChildOfClass("Tool")
    if tool then
        -- List of knives in Da Hood
        local knives = {"Knife", "Melee", "Kukri"}  -- Add more knife names if necessary
        for _, knife in ipairs(knives) do
            if tool.Name == knife then
                return true
            end
        end
    end
    return false
end

-- Raycast to check if there's a clear line of sight to the player (no walls blocking the view)
local function canSeePlayer(player)
    local camera = workspace.CurrentCamera
    local playerPos = player.Character:FindFirstChild("HumanoidRootPart") and player.Character.HumanoidRootPart.Position
    if not playerPos then return false end

    -- Raycast from the camera to the player's position
    local ray = workspace:Raycast(camera.CFrame.Position, (playerPos - camera.CFrame.Position).unit * 10000) -- Long-range raycast
    if ray and ray.Instance and ray.Instance.Parent == player.Character then
        return true
    end
    return false
end

-- Triggerbot functionality with raycasting for shooting in Da Hood
local function isAimingAtPlayer()
    local target = nil
    local camera = workspace.CurrentCamera
    
    -- Iterate through all players to check if they are in range and the crosshair is on them
    for _, player in ipairs(players:GetPlayers()) do
        if player ~= players.LocalPlayer and player.Character then
            local character = player.Character
            local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
            if humanoidRootPart then
                -- Specific body parts we want to check
                local bodyParts = {
                    character:FindFirstChild("Head"),
                    character:FindFirstChild("Torso"),
                    character:FindFirstChild("LeftLeg"),
                    character:FindFirstChild("RightLeg"),
                    character:FindFirstChild("LeftArm"),
                    character:FindFirstChild("RightArm"),
                }
                
                -- Loop through each body part and check if the crosshair is on them
                for _, part in ipairs(bodyParts) do
                    if part then
                        local screenPosition, onScreen = camera:WorldToScreenPoint(part.Position)
                        if onScreen then
                            -- Increase the size of the area considered as the "target" for the triggerbot
                            local crosshairDistance = (Vector2.new(screenPosition.X, screenPosition.Y) - Vector2.new(mouse.X, mouse.Y)).Magnitude
                            -- Triggerbot will shoot if the crosshair is within a 100-pixel radius of the player's body part
                            if crosshairDistance < 100 then
                                -- Only shoot if the player is visible (no walls in the way)
                                if canSeePlayer(player) then
                                    target = player
                                end
                            end
                        end
                    end
                end
            end
        end
    end
    return target
end

-- Simulate shooting action in Da Hood
local function shootAtPlayer(target)
    if target and target.Character then
        -- Check if the character has a humanoid
        local humanoid = target.Character:FindFirstChildOfClass("Humanoid")
        if humanoid then
            -- Check if a knife is equipped
            if isKnifeEquipped() then
                return  -- Don't shoot if a knife is equipped
            end

            -- Simulate the shooting action by calling a function from Da Hood's shooting system
            local gun = game.Players.LocalPlayer.Character:FindFirstChildOfClass("Tool")
            if gun and gun:IsA("Tool") then
                -- Activate the gun's shoot function. This works for guns in Da Hood, such as pistols.
                gun:Activate()
            end
        end
    end
end

local function activateTriggerbot()
    if triggerbotEnabled then
        local target = isAimingAtPlayer()  -- Get the player under the crosshair
        if target then
            -- Triggerbot: simulate shooting when the crosshair is over any part of the target's body
            shootAtPlayer(target)
        end
    end
end

-- Toggle triggerbot on/off with a key press
mouse.KeyDown:Connect(function(Key)
    if Key == macroToggleKey then
        -- Toggle speed glitch
        SpeedGlitch = not SpeedGlitch
        if SpeedGlitch then
            repeat 
                game:GetService("VirtualInputManager"):SendMouseWheelEvent("0", "0", true, game)
                wait(0.000001)
                game:GetService("VirtualInputManager"):SendMouseWheelEvent("0", "0", false, game)
                wait(0.000001)
            until not SpeedGlitch
        end
    elseif Key == triggerbotToggleKey then
        -- Toggle triggerbot on/off
        triggerbotEnabled = not triggerbotEnabled
        local status = triggerbotEnabled and "enabled" or "disabled"
        game:GetService("StarterGui"):SetCore("SendNotification", {
            Title = "Triggerbot", 
            Text = "Triggerbot " .. status,
            Duration = 3
        })
    end
end)

-- Wait for 3 seconds before changing the notification to "Ready!"
wait(3)

-- Change notification after 3 seconds
game:GetService("StarterGui"):SetCore("SendNotification", {
    Title = "Whitelisted", 
    Text = "Ready!",
    Icon = "rbxassetid://1234567890", -- Optional icon
    Duration = 3 -- Duration for the "Ready!" message
})

-- Update hitbox for other players periodically
runService.Heartbeat:Connect(function()
    -- If triggerbot is active, try to shoot
    if triggerbotEnabled then
        activateTriggerbot()
    end
end)
